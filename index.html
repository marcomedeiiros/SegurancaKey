<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="./style.css">
  <title>Gerador de Keys</title>
  <style>
    body {
      background: url("img/foto.svg") no-repeat center center fixed;
      background-size: cover;
      font-family: "Poppins", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: #fff;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .botão {
      width: 100%;
      height: 45px;
      background-color: rgb(43, 86, 226);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background-color 0.3s ease;
    }
    .botão:hover {
      background-color: rgba(0, 162, 255, 0.87);
    }
    .botão.apagar {
      background-color: rgb(88, 0, 0);
    }
    .botão.apagar:hover {
      background-color: darkred;
    }
    ul {
      list-style: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    li {
      background-color: rgba(255, 255, 255, 0.15);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      position: relative;
      color: #fff;
    }
    .senha-inativa {
      opacity: 0.4;
      text-decoration: line-through;
    }
    .acoes button {
      margin-right: 8px;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      color: white;
    }
    .acoes button:first-child {
      background-color: crimson;
    }
    .acoes button:last-child {
      background-color: goldenrod;
    }
    .acoes button.ativar {
      background-color: green;
    }
    .input-container {
      position: relative;
      width: 100%;
      height: 50px;
      margin-bottom: 15px;
    }
    .input-container select {
      width: 100%;
      height: 100%;
      background: transparent;
      border: 2px solid #5c5c5c;
      border-radius: 10px;
      font-size: 16px;
      color: #424242cb;
      padding: 0 45px 0 20px;
      outline: none;
      appearance: none;
      cursor: pointer;
    }
    .input-container::after {
      content: "▼";
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #8f8f8f;
      font-size: 14px;
    }
    .botãokey {
      width: 100%;
      height: 45px;
      background-color: rgba(0, 255, 55, 0.548);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background-color 0.3s ease;
    }
    .botãokey:hover {
      background-color: rgb(33, 170, 33);
    }
  </style>
  <script defer>
    const STORAGE_KEY = "senhas_criptografadas";

    document.addEventListener("DOMContentLoaded", () => {
      const senhas = carregarSenhas();
      const hoje = new Date();
      for (const senhaObj of senhas) {
        if (!isExpirada(senhaObj, hoje)) {
          adicionarSenhaNaLista(senhaObj);
        }
      }
    });

    async function criarSenha() {
      const senha = Math.random().toString(36).slice(2, 12);
      const hashHex = await sha256(senha);
      const duracao = document.getElementById("duracao").value;
      if (!duracao) {
        alert("Por favor, selecione o tempo de duração.");
        return;
      }
      const expiraEm = calcularDataExpiracao(duracao);
      const senhaObj = {
        senha,
        hashHex,
        desativada: false,
        duracao,
        expiraEm
      };
      salvarSenha(senhaObj);
      adicionarSenhaNaLista(senhaObj);
    }

    async function sha256(texto) {
      const encoder = new TextEncoder();
      const data = encoder.encode(texto);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function calcularDataExpiracao(duracao) {
      const hoje = new Date();
      let expiraEm = null;
      switch (duracao) {
        case "7dias":
          expiraEm = new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000);
          break;
        case "1mes":
          expiraEm = new Date(hoje);
          expiraEm.setMonth(expiraEm.getMonth() + 1);
          break;
        case "anual":
          expiraEm = new Date(hoje);
          expiraEm.setFullYear(expiraEm.getFullYear() + 1);
          break;
        case "permanente":
          expiraEm = null;
          break;
      }
      return expiraEm ? expiraEm.toISOString() : null;
    }

    function isExpirada(senhaObj, hoje = new Date()) {
      if (!senhaObj.expiraEm) return false;
      const expira = new Date(senhaObj.expiraEm);
      return expira < hoje;
    }

    function adicionarSenhaNaLista(senhaObj) {
      const lista = document.getElementById("lista-senhas");
      const item = document.createElement("li");
      item.dataset.hash = senhaObj.hashHex;
      let expiracaoTexto = "Permanente";
      if (senhaObj.expiraEm) {
        const dt = new Date(senhaObj.expiraEm);
        expiracaoTexto = dt.toLocaleDateString("pt-BR", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric"
        });
      }
      const classeInativa = senhaObj.desativada ? "senha-inativa" : "";
      item.className = classeInativa;
      item.innerHTML = `
        <div><strong>Key:</strong> ${senhaObj.senha}</div>
        <div><strong>Validade:</strong> ${expiracaoTexto}</div>
        <div class="acoes" style="margin-top: 8px;">
          ${senhaObj.desativada
            ? `<button class="ativar" onclick="ativarSenha(this)">Ativar novamente</button>`
            : `
              <button onclick="desativarSenha(this)">Desativar</button>
              <button onclick="inativarPermanente(this)">Inativar Permanente</button>
            `}
        </div>
      `;
      lista.appendChild(item);
    }

    function carregarSenhas() {
      const dados = localStorage.getItem(STORAGE_KEY);
      return dados ? JSON.parse(dados) : [];
    }

    function salvarSenha(senhaObj) {
      const senhas = carregarSenhas();
      senhas.push(senhaObj);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(senhas));
    }

    function atualizarSenha(hashHex, novosDados) {
      const senhas = carregarSenhas();
      const index = senhas.findIndex(s => s.hashHex === hashHex);
      if (index !== -1) {
        senhas[index] = { ...senhas[index], ...novosDados };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(senhas));
      }
    }

    function desativarSenha(btn) {
      const li = btn.closest("li");
      const hashHex = li.dataset.hash;
      li.remove();
      atualizarSenha(hashHex, { desativada: true });
    }

    function inativarPermanente(btn) {
      const li = btn.closest("li");
      const hashHex = li.dataset.hash;
      atualizarSenha(hashHex, { desativada: true });
      li.remove();
      const senhas = carregarSenhas();
      const senhaAtual = senhas.find(s => s.hashHex === hashHex);
      if (senhaAtual) adicionarSenhaNaLista(senhaAtual);
    }

    function ativarSenha(btn) {
      const li = btn.closest("li");
      const hashHex = li.dataset.hash;
      atualizarSenha(hashHex, { desativada: false });
      li.remove();
      const senhas = carregarSenhas();
      const senhaAtual = senhas.find(s => s.hashHex === hashHex);
      if (senhaAtual) adicionarSenhaNaLista(senhaAtual);
    }

    function apagarSenhas() {
      if (confirm("Tem certeza que deseja apagar todas as senhas?")) {
        localStorage.removeItem(STORAGE_KEY);
        document.getElementById("lista-senhas").innerHTML = "";
      }
    }

    function exportarParaJSON() {
      const senhas = carregarSenhas();
      const senhasAtivas = senhas.filter(s => !s.desativada && !isExpirada(s));
      if (!senhasAtivas.length) {
        alert("Nenhuma senha ativa para exportar.");
        return;
      }
      const jsonStr = JSON.stringify(senhasAtivas, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "senhas_ativas.json";
      link.click();
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>Gerador de Keys</h1>
    <div class="input-container">
      <select id="duracao" required>
        <option value="" disabled selected>Selecione o tempo de duração</option>
        <option value="7dias">7 dias</option>
        <option value="1mes">1 mês</option>
        <option value="anual">Anual</option>
        <option value="permanente">Permanente</option>
      </select>
    </div>

    <button class="botãokey" onclick="criarSenha()">Gerar Key</button>
    <button class="botão apagar" onclick="apagarSenhas()">Apagar Key</button>
    <button class="botão" onclick="exportarParaJSON()">Exportar JSON</button>

    <ul id="lista-senhas"></ul>
  </div>
</body>
</html>